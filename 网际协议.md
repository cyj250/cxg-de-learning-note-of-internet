**IPv4数据报格式**

![img](https://img-blog.csdn.net/20170511155357711?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvdTAxMTc4NDQ5NQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast)

* 版本号：4比特规定了数据报的IP协议版本。
* 首部长度：一个IPv4数据报可能包含一些可变量的选项，用这4比特来确定IP数据报中载荷实际开始的地方。一般的IP数据报具有20字节的首部长度。
* 服务类型：TOS比特包含在IPv4首部中，使不同类型的IP数据报能够相互区别开来。
* 数据报长度：IP数据报的总长度（首部加上数据），以字节计。IP数据报的理论最大长度为65535字节，但很少有超过1500字节的。
* 标识、标志、片偏移：与IP分片有关。
* 寿命：TTl确保数据报不会永远在网络中循环。
* 协议：通常到达最终目的地时才会使用。协议号是将网络层和传输层绑定到一起的粘合剂。
* 首部检验和：监测数据报中的比特错误。
* 选项：允许IP首部被扩展。
* 数据：有效载荷。

**IP数据报分片**

**最大传送单元**：一个链路层帧能承载的最大数据量。（MTU）

网络层数据报长度超过链路层MTU时，路由器会将数据报分成更小的片段，称为片

IPv4的设计者将数据报的重新组装工作放到了端系统中。

重组时，标识、标志、片偏移字段就起作用了：

生成一个数据报时，发送主机在为该数据报设置源和目的地址的同时贴上标识号。发送主机通常将它发送的每个数据报的标识号加1.当路由器需要对一个数据报分片时，形成的每个数据报具有初始数据报的源地址、目的地址与标识号。最后一个片的标志位被设置为0以确保接收主机能够收到初始数据报的最后一片。片偏移字段指定该片在初始数据报的哪个位置。

**IPv4编址**

主机接入网络的方法：一台主机通常只有一条链路连接到网络。主机与物理链路之间的边界叫做**接口**。路由器拥有两条及以上的链路，有多个接口。从技术上讲，一个IP 与一个接口相关联，而不是与包括该接口的主机或路由器相关联。

确定子网的方法：分开主机和路由器的每个接口，产生几个隔离的网络岛，使用接口端接这些隔离的网络的端点。这些隔离的网络中的每一个都叫作一个子网。

​	**寻址**

无类别域间路由选择。32比特的地址被划分为两部分，a.b.c.d/x , x的最高比特构成了IP地址的网络部分，并且经常被称为地址的**前缀**。

​	一台设备获取地址的过程：

 1. 获取一块地址

    分配机构分配给ISP一块地址，ISP再将这块地址划分成长度相同的连续地址块分配给下边的组织的子网中。

	2. 获取主机地址：动态主机配置协议

    路由器的IP地址通常由网络管理员手工配置，而主机地址可以手工配置，但通常使用动态主机配置协议（DHCP）来完成。一台主机从DHCP那里分到一个确定的IP或租用一个临时的IP，除了主机IP地址分配外，DHCP还允许每台主机得知其他信息，例如子网掩码、第一跳路由器地址（常称为默认网关）与它的本地DNS服务器的地址。DHCP也称为即插即用协议或零配置协议。

    一台新主机到达获取地址的步骤：

    1. DHCP服务器发现。可通过DHCP发现报文来发现一个要与其交互的DHCP服务器。
    2. DHCP服务提供。DHCP服务器收到一个DHCP发现报文时，用DHCP提供报文向客户做出响应，
    3. DHCP请求。新到达的客户从一个或多个服务器中选择一个，并向选中的服务器提供用DHCP请求报文进行响应，回显配置参数。
    4. DHCP ACK。服务器用DHCP ACK报文对DHCP请求报文进行响应，证实所要求的参数。

<img src="C:\Users\cyj250\AppData\Roaming\Typora\typora-user-images\image-20210312162927490.png" alt="image-20210312162927490" style="zoom:200%;" />

**网络地址转换**

NAT。

**Ipv6**

IPv6数据报格式

![img](http://blog.chinaunix.net/attachment/201205/13/9112803_1336895498zSUG.png)

**版本号(version)**

  不同的IP协议版本使用不同的数据报格式。

**通信量等级(Traffic Classes)**

  使得源节点和路由器能够识别IPv6信息包的优先级。与IPv4服务类型TOS字段含义类似。

**流标签(Flow Label)**

  标记那些需要IPv6路由器**特殊处理**(如一种非默认服务质量或实时服务)的信息包顺序。

**有效负载长度(Payload Length)**

  定长40字节数据报首部后面的字节数量，包括扩展报头和负载数据，即数据报长度-40。

**下一个首部(Next Header)**

  当IPv6没有扩展报头时，该字段的作用和IPv4的上层协议字段一样。当含有扩展报头时，该字段的值即为第一个扩展报头的类型。

**跳限制(Hop Limit)**

  转发数据报的每台路由器对该字段的值减1，若减为0则丢弃该数据报。

**源和目的IP地址(Source/Destination Address)**

**数据(Data)**

  当数据报到达目的地时，该有效载荷就从IP数据报移出，并交给下一个首部字段中指定的协议。

**源和目的IP地址(Source/Destination Address)**

**选项(Options)**

  选项字段允许IP首部被扩展，由此导致数据报首部长度可变，故不能预先确定数据字段从何开始，同时也使路由器处理一个IP数据报所需时间差异很大(有的要处理选项，有的不需要)。

**数据(Data)**

  当使用TCP/UDP协议时，数据即为传输层报文段(TCP/UDP)。数据字段也可承载其他类型数据，如ICMP报文段。

**区别**

**3.1 首部长度**

  首部长度可变，IPv4首部的**选项字段**允许IP首部被扩展，由此导致数据报首部长度可变，故**不能预先确定数据字段从何开始**，同时也使**路由器处理一个IP数据报所需时间差异很大**(有的要处理选项，有的不需要)。基于此，IPv6采用固定40字节长度的报头长度(称基本报头)。IPv6如何实现IPv4选项字段类似的功能，答案是扩展报头，并由IPv6基本报头的下一个首部指向扩展报头(如果有的话)。路由器不处理扩展报头，提升了路由器处理效率。

**3.2 分片/重组**

  IPv6，分片与重组只能在源与目的地上执行，**不允许在中间路由器进行**。分片与重组是个耗时的操作，将该功能从路由器转移到端系统，大大加快了网络中的IP转发速率。那，如果路由器收到IPv6数据报太大而不能转发到出链路上怎么办？该路由器丢弃该包，并向发送发发回一个"分组太大"的ICMP差错报文，于是发送发使用较小长度的IP数据报重发数据。

**3.3 首部检查和**

  每个路由器上，IPv4首部检查和都需要重新计算，是一项耗时操作。加之，传输层和链接层协议执行了检验操作，网络传输可靠性提升，所以IPv6不进行首部检查和，从而更快速处理IP分组。